<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç€é †åˆ¤å®šãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ£ãƒ³</title>
    <meta name="theme-color" content="#4f46e5" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { font-family: 'Inter', sans-serif; }
        #result-container {
            overflow-x: auto;
            white-space: nowrap;
            cursor: grab;
        }
        #capture-canvas {
            position: fixed;
            top: -9999px;
            left: -9999px;
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-6 font-bold text-center">
            ğŸ“¸ ãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ£ãƒ³ ç€é †åˆ¤å®šãƒ„ãƒ¼ãƒ«ï¼ˆé«˜é€ŸPWAç‰ˆï¼‰
        </h1>

        <div id="message-box" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-6 shadow-md" role="alert">
            <p class="font-bold">ğŸ é«˜é€Ÿæ’®å½±å¯¾å¿œç‰ˆ (æœ€å¤§30km/hç›®å®‰)</p>
            <p class="text-sm">ã“ã®ã‚¢ãƒ—ãƒªã¯PWAã«å¯¾å¿œã—ã¦ãŠã‚Šã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚ä¸‹ã®ã€Œã‚«ãƒ¡ãƒ©èµ·å‹•ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
        </div>

        <div id="video-wrapper" class="relative w-full aspect-video bg-gray-800 rounded-xl overflow-hidden shadow-2xl mb-6 flex justify-center items-center">
            <video id="video" playsinline autoplay muted class="hidden"></video>
            <p id="video-placeholder" class="text-white text-center z-20">ã‚«ãƒ¡ãƒ©æ˜ åƒã®æº–å‚™ä¸­...</p>
            <div id="scan-line" class="absolute h-full w-0.5 bg-red-500 pointer-events-none opacity-75 transition-all duration-1000 z-30" style="left: 50%;"></div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
            <div id="camera-select-container" class="flex flex-col w-full md:w-1/3">
                <label for="camera-select" class="text-gray-700 text-sm font-semibold mb-1">ã‚«ãƒ¡ãƒ©é¸æŠ:</label>
                <select id="camera-select" class="p-2 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-800 w-full" disabled>
                    <option value="">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹ã¨é¸æŠã§ãã¾ã™</option>
                </select>
            </div>

            <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto md:ml-4">
                <button id="setup-camera-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200" onclick="setupCamera()">
                    ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•
                </button>

                <button id="start-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200" onclick="startScanning()" disabled>
                    â–¶ï¸ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
                </button>
                <button id="stop-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 hidden" onclick="stopScanning()">
                    â¹ï¸ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢
                </button>
            </div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-lg mb-6 flex items-center justify-center">
            <div class="flex items-center space-x-4">
                <label for="scan-offset" class="text-gray-700 text-sm font-semibold whitespace-nowrap">åˆ¤å®šãƒ©ã‚¤ãƒ³ä½ç½®èª¿æ•´:</label>
                <input type="range" id="scan-offset" min="-150" max="150" value="0" step="1" class="w-48 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <span id="offset-value" class="text-indigo-600 font-bold w-10 text-right">0</span>
            </div>
        </div>

        <h2 class="text-xl font-semibold text-gray-800 mb-3">åˆ¤å®šçµæœ (ãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ£ãƒ³ç”»åƒ)</h2>
        <div id="result-container" class="w-full h-80 bg-gray-900 rounded-xl shadow-inner border border-gray-300 overflow-x-scroll">
            <canvas id="result-canvas" class="h-full"></canvas>
        </div>
        <p class="text-sm text-gray-600 mt-2">â€» ç”»åƒã‚’å·¦å³ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€é€šéã—ãŸç¬é–“ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>

        <div class="mt-6 text-center">
            <button id="download-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-200 hidden" onclick="downloadResult()">
                â¬‡ï¸ï¸ åˆ¤å®šç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
        </div>
    </div>

    <canvas id="capture-canvas"></canvas>

    <script>
        // DOMè¦ç´ 
        const video = document.getElementById('video');
        const videoPlaceholder = document.getElementById('video-placeholder');
        const captureCanvas = document.getElementById('capture-canvas');
        const captureCtx = captureCanvas.getContext('2d');
        const resultCanvas = document.getElementById('result-canvas');
        const resultCtx = resultCanvas.getContext('2d');
        const setupCameraButton = document.getElementById('setup-camera-button');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const downloadButton = document.getElementById('download-button');
        const messageBox = document.getElementById('message-box');
        const scanLine = document.getElementById('scan-line');
        const scanOffsetInput = document.getElementById('scan-offset');
        const offsetValueSpan = document.getElementById('offset-value');
        const resultContainer = document.getElementById('result-container');
        const cameraSelect = document.getElementById('camera-select');

        let stream = null;
        let scanning = false;
        let scanX = 0;
        let animationFrameId = null;
        const FRAME_WIDTH = 1;
        const RESULT_HEIGHT = 320;

        let videoDevices = [];

        // PWA helpers (same aså…ƒã‚³ãƒ¼ãƒ‰)
        const toBase64 = (str) => {
            try {
                const latin1String = unescape(encodeURIComponent(str));
                return btoa(latin1String);
            } catch (e) {
                return btoa(str);
            }
        };

        const createManifestDataUrl = () => {
            const manifest = {
                name: "ãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ£ãƒ³ ç€é †åˆ¤å®š",
                short_name: "PhotoFinish",
                description: "ãƒ¢ãƒã‚¤ãƒ«ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ãŸé«˜ç²¾åº¦ãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ£ãƒ³ç€é †åˆ¤å®šãƒ„ãƒ¼ãƒ«",
                start_url: "./",
                display: "standalone",
                background_color: "#ffffff",
                theme_color: "#4f46e5",
                icons: [{ src: "icon.png", sizes: "192x192", type: "image/png" }]
            };
            const utf8String = JSON.stringify(manifest);
            return 'data:application/json;base64,' + toBase64(utf8String);
        };

        const serviceWorkerCode = `
            const CACHE_NAME = 'linescan-v2';
            const urlsToCache = ['/', 'index.html', 'https://cdn.tailwindcss.com'];
            self.addEventListener('install', (event) => {
                event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                self.skipWaiting();
            });
            self.addEventListener('fetch', (event) => {
                event.respondWith(caches.match(event.request).then(response => response || fetch(event.request)));
            });
            self.addEventListener('activate', (event) => {
                const cacheWhitelist = [CACHE_NAME];
                event.waitUntil(caches.keys().then((cacheNames) => {
                    return Promise.all(cacheNames.map(cacheName => {
                        if (cacheWhitelist.indexOf(cacheName) === -1) return caches.delete(cacheName);
                    }));
                }));
                return self.clients.claim();
            });
        `;

        const registerServiceWorker = () => {
            if ('serviceWorker' in navigator) {
                const swBase64 = toBase64(serviceWorkerCode);
                const swUrl = `data:application/javascript;base64,${swBase64}`;
                navigator.serviceWorker.register(swUrl, { scope: './' })
                    .then(reg => console.log('Service Worker ç™»éŒ²æˆåŠŸ:', reg.scope))
                    .catch(error => {
                        console.warn('Service Worker ç™»éŒ²å¤±æ•—:', error);
                        // å¤šãã®ç’°å¢ƒã§ Data URL ã§ã®ç™»éŒ²ã¯ä¸å¯ -> ç„¡è¦–ã—ã¦ç¶šè¡Œ
                    });
            } else {
                console.warn('Service Worker æœªã‚µãƒãƒ¼ãƒˆ');
            }
        };

        const setupPWA = () => {
            try {
                const link = document.createElement('link');
                link.rel = 'manifest';
                link.href = createManifestDataUrl();
                document.head.appendChild(link);
                registerServiceWorker();
            } catch (e) {
                console.warn('PWA setup failed:', e);
            }
        };

        document.addEventListener('DOMContentLoaded', setupPWA);

        // åˆæœŸ result canvas é«˜ã•ã‚’è¨­å®šï¼ˆæç”»å‰ã«å¿…ãšé«˜ã•ã‚’ã‚»ãƒƒãƒˆï¼‰
        resultCanvas.height = RESULT_HEIGHT;
        resultCtx.imageSmoothingEnabled = false;

        // ã‚¹ã‚­ãƒ£ãƒ³ã‚ªãƒ•ã‚»ãƒƒãƒˆè¡¨ç¤º
        scanOffsetInput.addEventListener('input', (e) => {
            const offsetPercent = parseInt(e.target.value, 10);
            offsetValueSpan.textContent = offsetPercent;
            scanLine.style.left = `calc(50% + ${offsetPercent}px)`;
        });

        // ã‚«ãƒ¡ãƒ©é¸æŠå¤‰æ›´
        cameraSelect.addEventListener('change', () => {
            if (scanning) stopScanning();
            setupCamera(cameraSelect.value);
        });

        // ãƒ‡ãƒã‚¤ã‚¹åˆ—æŒ™ã¨UIæ›´æ–°
        async function updateDeviceList(selectedDeviceId = null) {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(d => d.kind === 'videoinput');
                cameraSelect.innerHTML = '';
                if (videoDevices.length === 0) {
                    cameraSelect.disabled = true;
                    cameraSelect.innerHTML = '<option value="">ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
                    return;
                }
                videoDevices.forEach((device, idx) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `ã‚«ãƒ¡ãƒ© ${idx + 1}`;
                    cameraSelect.appendChild(option);
                });
                if (selectedDeviceId) cameraSelect.value = selectedDeviceId;
                else cameraSelect.value = videoDevices[0].deviceId;
                cameraSelect.disabled = false;
            } catch (err) {
                console.error("ãƒ‡ãƒã‚¤ã‚¹åˆ—æŒ™ã‚¨ãƒ©ãƒ¼:", err);
                cameraSelect.disabled = true;
                cameraSelect.innerHTML = '<option value="">ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆå–å¾—å¤±æ•—</option>';
            }
        }

        // ã‚«ãƒ¡ãƒ©è¨­å®šï¼ˆdeviceId optionalï¼‰
        async function setupCamera(deviceId = null) {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }

            setupCameraButton.disabled = true;
            startButton.disabled = true;
            cameraSelect.disabled = true;

            messageBox.className = 'bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg mb-6 shadow-md';
            messageBox.innerHTML = '<p class="font-bold">ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­... (ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰è¨±å¯ã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™)</p>';

            let streamSuccess = false;
            let lastError = null;
            let constraintsList = [];
            const fpsConstraint = { frameRate: { ideal: 60 } };

            if (deviceId) {
                constraintsList.push({ audio: false, video: { deviceId: { exact: deviceId }, ...fpsConstraint } });
            } else {
                constraintsList.push({ audio: false, video: { facingMode: 'environment', ...fpsConstraint } });
                constraintsList.push({ audio: false, video: { facingMode: 'user', ...fpsConstraint } });
                constraintsList.push({ audio: false, video: fpsConstraint });
            }

            if (deviceId) constraintsList = constraintsList.slice(0, 1);

            for (const constraints of constraintsList) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    streamSuccess = true;
                    break;
                } catch (err) {
                    lastError = err;
                    console.warn(`ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œå¤±æ•— (constraints: ${JSON.stringify(constraints.video)}):`, err && err.name, err && err.message);
                }
            }

            if (streamSuccess && stream) {
                video.srcObject = stream;
                try {
                    await new Promise((resolve) => {
                        video.onloadedmetadata = () => {
                            video.play().catch(e => console.warn("Video play failed:", e));
                            resolve();
                        };
                    });
                } catch (e) {
                    console.warn("video play error:", e);
                }

                video.classList.remove('hidden');
                videoPlaceholder.classList.add('hidden');

                // getSettings().deviceId ãŒæœªå®šç¾©ã®å ´åˆãŒã‚ã‚‹ -> try/catch
                let currentDeviceId = null;
                try {
                    currentDeviceId = stream.getVideoTracks()[0].getSettings().deviceId || null;
                } catch (e) {
                    currentDeviceId = null;
                }
                await updateDeviceList(currentDeviceId);

                startButton.disabled = false;
                setupCameraButton.classList.add('hidden');
                setupCameraButton.disabled = true;
                cameraSelect.disabled = false;

                messageBox.className = 'bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg mb-6 shadow-md';
                messageBox.innerHTML = '<p class="font-bold">âœ… ã‚¹ãƒ†ãƒƒãƒ—2: ã‚«ãƒ¡ãƒ©æº–å‚™å®Œäº†</p><p class="text-sm">ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ãƒ©ã‚¤ãƒ³ã‚’ä¸­å¤®ã«åˆã‚ã›ã€ã€Œã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>';
                return true;
            } else {
                console.error("ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: æœ€çµ‚çš„ãªå¤±æ•—", lastError);
                startButton.disabled = true;
                setupCameraButton.disabled = false;
                setupCameraButton.classList.remove('hidden');

                let err = lastError;
                let errorMessage =
                    '<p class="font-bold">âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—</p>' +
                    '<p class="text-sm">ã‚¨ãƒ©ãƒ¼: ' + (err?.name || 'ä¸æ˜') + ' - ' + (err?.message || 'è©³ç´°ä¸æ˜') + '</p>';
                let retryButtonHtml = '<button onclick="setupCamera()" class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700">å†è©¦è¡Œ</button>';

                if (err?.name === 'NotAllowedError' || (err?.message && err.message.includes('denied'))) {
                    errorMessage =
                        '<p class="font-bold">ğŸš¨ æ¨©é™æ‹’å¦ã‚¨ãƒ©ãƒ¼ (Permission Denied)</p>' +
                        '<p class="text-sm mt-1 font-semibold text-red-800">ã‚«ãƒ¡ãƒ©ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶/OSã®æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>' +
                        retryButtonHtml;
                } else if (err?.name === 'NotReadableError') {
                    errorMessage =
                        '<p class="font-bold">âš ï¸ ã‚«ãƒ¡ãƒ©ä½¿ç”¨ä¸­ã‚¨ãƒ©ãƒ¼ (NotReadableError)</p>' +
                        '<p class="text-sm mt-1">ä»–ã®ã‚¢ãƒ—ãƒªã§ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ä¸­ã§ã™ã€‚é–‰ã˜ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>' +
                        retryButtonHtml;
                } else {
                    errorMessage += '<p class="mt-3 text-xs">å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã¯ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>' + retryButtonHtml;
                }

                messageBox.className = 'bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg mb-6 shadow-md';
                messageBox.innerHTML = errorMessage;

                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                return false;
            }
        }

        // ãƒ—ãƒ­ã‚»ã‚¹ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
        function processFrame() {
            if (!scanning || video.paused || video.ended) return;

            // captureCanvas ã®å¤§ãã•ã‚’ãƒ“ãƒ‡ã‚ªã«åˆã‚ã›ã‚‹
            captureCanvas.width = video.videoWidth || captureCanvas.width || 640;
            captureCanvas.height = video.videoHeight || captureCanvas.height || 480;

            // çµæœã‚­ãƒ£ãƒ³ãƒã‚¹ã®é«˜ã•ã‚’å¸¸ã«å›ºå®š
            if (resultCanvas.height !== RESULT_HEIGHT) resultCanvas.height = RESULT_HEIGHT;

            try {
                captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
            } catch (e) {
                // æç”»ã§ããªã„ãƒ•ãƒ¬ãƒ¼ãƒ ã¯ã‚¹ã‚­ãƒƒãƒ—
                console.warn('drawImage failed:', e);
                if (scanning) animationFrameId = requestAnimationFrame(processFrame);
                return;
            }

            // ã‚ªãƒ•ã‚»ãƒƒãƒˆã¨ scanLineX ã‚’è¨ˆç®—ã—ã¦ç¯„å›²å†…ã«åã‚ã‚‹ï¼ˆclampï¼‰
            const offset = parseInt(scanOffsetInput.value, 10) || 0;
            let scanLineX = Math.floor(captureCanvas.width / 2) + offset;
            scanLineX = Math.max(0, Math.min(captureCanvas.width - FRAME_WIDTH, scanLineX));

            // æ—¢å­˜ã®ç”»åƒã‚’èª­ã¿å–ã‚‹ï¼ˆ0å¹…ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            const resultWidth = resultCanvas.width || 0;
            let existingData = null;
            if (resultWidth > 0) {
                try {
                    existingData = resultCtx.getImageData(0, 0, resultWidth, RESULT_HEIGHT);
                } catch (e) {
                    console.warn("æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã‚¨ãƒ©ãƒ¼:", e);
                    existingData = null;
                }
            }

            // çµæœã‚­ãƒ£ãƒ³ãƒã‚¹ã®å¹…ã‚’æ‹¡å¼µï¼ˆheight ã¯å›ºå®šï¼‰
            const newWidth = resultWidth + FRAME_WIDTH;
            // ä¿å­˜ã—ã¦ã‹ã‚‰å¹…ã‚’å¤‰ãˆã‚‹ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹å¹…ã‚’å¤‰ãˆã‚‹ã¨å†…å®¹ã¯ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ï¼‰
            resultCanvas.width = newWidth;
            resultCanvas.height = RESULT_HEIGHT;
            resultCtx.imageSmoothingEnabled = false;

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            if (existingData) {
                try {
                    resultCtx.putImageData(existingData, 0, 0);
                } catch (e) {
                    console.warn("æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚¨ãƒ©ãƒ¼:", e);
                }
            }

            // ã‚­ãƒ£ãƒ—ãƒãƒ£ã‹ã‚‰1åˆ—ã‚’å–ã‚Šå‡ºã™
            try {
                const imageData = captureCtx.getImageData(scanLineX, 0, FRAME_WIDTH, captureCanvas.height);
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = FRAME_WIDTH;
                tempCanvas.height = captureCanvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.putImageData(imageData, 0, 0);

                // çµæœã‚­ãƒ£ãƒ³ãƒã‚¹ã®é«˜ã•ã«åˆã‚ã›ã¦ç¸®å°ï¼ˆã‚‚ã—ãã¯ä¼¸å¼µï¼‰ã—ã¦å³ç«¯ã«æç”»
                resultCtx.drawImage(tempCanvas, resultWidth, 0, FRAME_WIDTH, RESULT_HEIGHT);
            } catch (e) {
                console.warn("ã‚¹ãƒªãƒƒãƒˆå–å¾—/æç”»ã‚¨ãƒ©ãƒ¼:", e);
            }

            scanX += FRAME_WIDTH;
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å³ç«¯ã¸ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§æˆ»ã—ã¦ã„ã‚‹å ´åˆã¯ç„¡ç†ã«æˆ»ã•ãªã„å®Ÿè£…ã‚‚å¯èƒ½ï¼‰
            resultContainer.scrollLeft = resultContainer.scrollWidth;

            if (scanning) {
                animationFrameId = requestAnimationFrame(processFrame);
            }
        }

        // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
        async function startScanning() {
            if (!stream || startButton.disabled) {
                messageBox.className = 'bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg mb-6 shadow-md';
                messageBox.innerHTML = '<p class="font-bold">ğŸš¨ è­¦å‘Š</p><p class="text-sm">å…ˆã«ã€Œã‚«ãƒ¡ãƒ©èµ·å‹•ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }
            if (scanning) return;

            scanning = true;
            scanX = 0;

            startButton.classList.add('hidden');
            stopButton.classList.remove('hidden');
            downloadButton.classList.add('hidden');
            cameraSelect.disabled = true;

            messageBox.className = 'bg-indigo-100 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-lg mb-6 shadow-md';
            messageBox.innerHTML = '<p class="font-bold">ğŸŸ¢ ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</p><p class="text-sm">ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ãƒ©ã‚¤ãƒ³ã‚’ç”»é¢ä¸­å¤®ã«ç¶­æŒã—ã¦ãã ã•ã„ã€‚</p>';

            // çµæœã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ–ï¼ˆå¹…ã¯0â†’æ‹¡å¼µï¼‰
            resultCanvas.width = 0;
            resultCanvas.height = RESULT_HEIGHT;
            resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);

            animationFrameId = requestAnimationFrame(processFrame);
        }

        // ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢
        function stopScanning() {
            scanning = false;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);

            startButton.classList.remove('hidden');
            stopButton.classList.add('hidden');
            downloadButton.classList.remove('hidden');
            cameraSelect.disabled = false;

            messageBox.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-6 shadow-md';
            messageBox.innerHTML = '<p class="font-bold">â¸ï¸ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</p><p class="text-sm">ä¸‹ã®ç”»åƒã‚’å·¦å³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ç€é †ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚</p>';
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadResult() {
            try {
                const dataURL = resultCanvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = `PhotoFinish_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (e) {
                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—:', e);
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆpointerã‚¤ãƒ™ãƒ³ãƒˆã§ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã‚’çµ±ä¸€ï¼‰
        let isDragging = false;
        let startX = 0;
        let scrollLeft = 0;

        resultContainer.addEventListener('pointerdown', (e) => {
            isDragging = true;
            resultContainer.setPointerCapture(e.pointerId);
            resultContainer.style.cursor = 'grabbing';
            const rect = resultContainer.getBoundingClientRect();
            startX = e.clientX - rect.left;
            scrollLeft = resultContainer.scrollLeft;
            e.preventDefault();
        });

        resultContainer.addEventListener('pointermove', (e) => {
            if (!isDragging) return;
            const rect = resultContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const walk = (x - startX) * 1.5;
            resultContainer.scrollLeft = scrollLeft - walk;
        });

        resultContainer.addEventListener('pointerup', (e) => {
            isDragging = false;
            try { resultContainer.releasePointerCapture(e.pointerId); } catch (er) {}
            resultContainer.style.cursor = 'grab';
        });

        resultContainer.addEventListener('pointerleave', () => {
            isDragging = false;
            resultContainer.style.cursor = 'grab';
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆå–å¾—ã‚’è©¦ã¿ã‚‹ï¼ˆæ¨©é™ãŒå¿…è¦ãªå ´åˆã¯å‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ãŒã€ç„¡å®³ï¼‰
        (async () => {
            try {
                await updateDeviceList();
            } catch (e) {
                // ç„¡è¦–ã—ã¦ç¶šè¡Œ
            }
        })();

    </script>
</body>
</html>
