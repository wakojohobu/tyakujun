<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>着順判定らくらく君（タイム計測対応）</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f0f4f9;
  margin: 0; padding: 10px;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  text-align: center;
}
button {
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
}
video, canvas {
  width: 100%;
  max-width: 800px;
  border-radius: 12px;
  background: #000;
}
.controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 6px;
  margin: 10px 0;
}
.slider {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 10px;
}
#result-container {
  overflow-x: auto;
  white-space: nowrap;
  background: #fff;
  border-radius: 12px;
  padding: 4px;
  margin-top: 8px;
}
#result-canvas {
  background: #000;
  border-radius: 10px;
}
.label {
  font-size: 0.9em;
  font-weight: bold;
}
#stopwatch-display {
  font-family: monospace;
  font-size: 1.2em;
  color: #2b5fff;
}
</style>
</head>
<body>
<div class="container">
  <h2>🏁 着順判定らくらく君（＋タイム計測）</h2>

  <!-- カメラ起動・スキャン操作 -->
  <div class="controls">
    <button id="start-camera" style="background:#2196f3;color:white;padding:8px 14px;">📷 カメラ起動</button>
    <button id="start-scan" style="background:#4caf50;color:white;padding:8px 14px;">▶️ スキャン開始</button>
    <button id="stop-scan" style="background:#f44336;color:white;padding:8px 14px;">⏹ 停止</button>
  </div>

  <!-- ストップウォッチ -->
  <div class="controls">
    <button style="background:#43a047;color:white;padding:8px 12px;" onclick="startStopwatch()">⏱ スタート</button>
    <button style="background:#e53935;color:white;padding:8px 12px;" onclick="stopStopwatch()">⏹ ストップ</button>
    <button style="background:#ffb300;color:white;padding:8px 12px;" onclick="resetStopwatch()">🔄 リセット</button>
    <span id="stopwatch-display">00:00.00</span>
  </div>

  <!-- スリット調整 -->
  <div class="slider">
    <label class="label">ライン位置:
      <input type="range" id="scan-offset" min="-150" max="150" value="0" step="1">
      <span id="offset-value">0</span>
    </label>
    <label class="label">スリット幅:
      <input type="range" id="slit-width" min="1" max="20" value="5" step="1">
      <span id="slit-value">5</span>
    </label>
    <small style="color:#666;">※スリット幅は切り取るラインの太さです。<br>
      小さいほど精密、大きいほど形が見やすくなります。</small>
  </div>

  <video id="video" autoplay playsinline></video>
  <canvas id="capture-canvas" hidden></canvas>

  <div id="result-container">
    <canvas id="result-canvas" height="320"></canvas>
  </div>
</div>

<script>
let video = document.getElementById('video');
let captureCanvas = document.getElementById('capture-canvas');
let captureCtx = captureCanvas.getContext('2d');
let resultCanvas = document.getElementById('result-canvas');
let resultCtx = resultCanvas.getContext('2d');
let scanning = false, FRAME_WIDTH = 5, scanOffset = 0;
let stopwatchStart = 0, stopwatchElapsed = 0, stopwatchTimer = null;
let startTime = null;
let resultWidth = 0;

// --- ストップウォッチ ---
function updateStopwatchDisplay(){
  const total = (performance.now()-stopwatchStart)+stopwatchElapsed;
  const ms=Math.floor(total%1000/10);
  const s=Math.floor(total/1000)%60;
  const m=Math.floor(total/60000);
  document.getElementById('stopwatch-display').textContent =
    `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${ms.toString().padStart(2,'0')}`;
}
function startStopwatch(){
  if(stopwatchTimer) return;
  stopwatchStart = performance.now();
  stopwatchTimer = setInterval(updateStopwatchDisplay, 33);
}
function stopStopwatch(){
  if(!stopwatchTimer) return;
  stopwatchElapsed += (performance.now()-stopwatchStart);
  clearInterval(stopwatchTimer);
  stopwatchTimer = null;
}
function resetStopwatch(){
  clearInterval(stopwatchTimer);
  stopwatchTimer=null;
  stopwatchElapsed=0;
  stopwatchStart=performance.now();
  document.getElementById('stopwatch-display').textContent='00:00.00';
}

// --- カメラ起動 ---
document.getElementById('start-camera').onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  video.srcObject = stream;
};

// --- スリット調整 ---
document.getElementById('scan-offset').oninput = e => {
  scanOffset = parseInt(e.target.value);
  document.getElementById('offset-value').textContent = scanOffset;
};
document.getElementById('slit-width').oninput = e => {
  FRAME_WIDTH = parseInt(e.target.value);
  document.getElementById('slit-value').textContent = FRAME_WIDTH;
};

// --- スキャン開始 ---
document.getElementById('start-scan').onclick = () => {
  if (!video.srcObject) return alert("📷 カメラを起動してください。");
  scanning = true;
  resultWidth = 0;
  resultCanvas.width = 1;
  startTime = performance.now();
  processFrame();
};

// --- 停止 ---
document.getElementById('stop-scan').onclick = () => { scanning = false; };

// --- 判定ロジック ---
function detectTeamColor(r,g,b){
  if(r>200 && g<80 && b<80) return "赤";
  if(r>200 && g>200 && b>200) return "白";
  if(r<80 && g<80 && b>200) return "青";
  if(r>200 && g>200 && b<100) return "黄";
  if(r<80 && g>150 && b<80) return "緑";
  return null;
}

let lastColor = null;
let rank = 0;

function processFrame(){
  if(!scanning) return;
  captureCanvas.width = video.videoWidth;
  captureCanvas.height = video.videoHeight;
  captureCtx.drawImage(video,0,0);
  const x = Math.floor(video.videoWidth/2 + scanOffset);
  const frame = captureCtx.getImageData(x,0,FRAME_WIDTH,video.videoHeight);
  
  // 判定
  let colorCount = {赤:0,白:0,青:0,黄:0,緑:0};
  const data = frame.data;
  for(let i=0;i<data.length;i+=4){
    const c = detectTeamColor(data[i],data[i+1],data[i+2]);
    if(c) colorCount[c]++;
  }
  const detected = Object.entries(colorCount).sort((a,b)=>b[1]-a[1])[0];
  const color = (detected[1]>50)?detected[0]:null;

  // 通過検出
  if(color && color!==lastColor){
    rank++;
    const now = performance.now();
    const diff = now - stopwatchStart + stopwatchElapsed;
    const ms=Math.floor(diff%1000/10);
    const s=Math.floor(diff/1000)%60;
    const m=Math.floor(diff/60000);
    const timeStr=`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${ms.toString().padStart(2,'0')}`;
    
    // タイム描画
    resultCtx.fillStyle="white";
    resultCtx.font="16px sans-serif";
    resultCtx.fillText(`${rank}位(${color}) ${timeStr}`, resultWidth+10, 20*(rank%15+1));
  }
  lastColor = color;

  // ラインスキャン画像描画
  resultWidth += FRAME_WIDTH;
  resultCanvas.width = resultWidth;
  resultCtx.drawImage(captureCanvas, x, 0, FRAME_WIDTH, captureCanvas.height,
                      resultWidth-FRAME_WIDTH, 0, FRAME_WIDTH, resultCanvas.height);
  document.getElementById("result-container").scrollLeft = resultCanvas.width;

  requestAnimationFrame(processFrame);
}
</script>
</body>
</html>
